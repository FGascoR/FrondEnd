<div class="container mt-4">
  <h4 class="mb-3">Gestión de Penalidades</h4>

  <div class="row g-3 mb-3" [formGroup]="filterForm">
    <div class="col-md-4">
      <label class="form-label">Cliente</label>
      <input type="text" class="form-control" formControlName="clienteNombre" placeholder="Nombre o Apellido...">
    </div>
    <div class="col-md-4">
      <label class="form-label">Estado</label>
      <select class="form-select" formControlName="estado">
        <option [ngValue]="null">Todos</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Pagada">Pagada</option>
        <option value="Concluida">Concluida</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha de Penalidad</label>
      <input type="date" class="form-control" formControlName="fecha">
    </div>
  </div>

  <table class="table table-striped table-hover mt-3">
    <thead class="table-secondary">
      <tr>
        <th>Cliente</th>
        <th>Fecha</th>
        <th>Tipo</th> 
        <th>Motivo</th>
        <th class="text-end">Monto (S/.)</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let penalidad of penalidades">
        <td>{{ penalidad.cliente?.nombres }} {{ penalidad.cliente?.apellidoPaterno }}</td>
        <td>{{ penalidad.fechaPenalidad | date: 'dd/MM/yyyy' }}</td>
        
        <td>
          <span class="badge rounded-pill" 
                [ngClass]="penalidad.tipo === 'Monetaria' ? 'bg-warning text-dark' : 'bg-info text-dark'">
            {{ penalidad.tipo || 'Monetaria' }}
          </span>
        </td>

        <td>{{ penalidad.motivo }}</td>
        
        <td class="text-end">
          <span *ngIf="penalidad.tipo === 'Monetaria'">
            {{ penalidad.monto | number: '1.2-2' }}
          </span>
          <span *ngIf="penalidad.tipo !== 'Monetaria'" class="text-muted small">
            -
          </span>
        </td>
        
        <td>
          <span [ngClass]="getEstadoClass(penalidad.estado)">
            {{ penalidad.estado }}
          </span>
        </td>
        <td>
          <button *ngIf="penalidad.estado === 'Pendiente'" 
                  class="btn btn-sm"
                  [ngClass]="penalidad.tipo === 'Monetaria' ? 'btn-success' : 'btn-primary'" 
                  (click)="openResolucionModal(penalidad)">
            
            <i class="bi" [ngClass]="penalidad.tipo === 'Monetaria' ? 'bi-cash-coin' : 'bi-unlock-fill'"></i>
            {{ penalidad.tipo === 'Monetaria' ? 'Marcar como Pagado' : 'Concluir Penalidad' }}
          </button>

          <span *ngIf="penalidad.estado !== 'Pendiente'" class="text-muted small">
            <i class="bi bi-check-all"></i> 
            {{ penalidad.estado === 'Pagada' ? 'Pagado' : 'Concluida' }}
          </span>
        </td>
      </tr>
      
      <tr *ngIf="isLoading">
        <td colspan="7" class="text-center">Cargando penalidades...</td>
      </tr>
      <tr *ngIf="!isLoading && penalidades.length === 0">
        <td colspan="7" class="text-center">No hay penalidades para mostrar.</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="modal fade" id="resolucionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header text-white"
           [ngClass]="selectedPenalidad?.tipo === 'Monetaria' ? 'bg-success' : 'bg-primary'">
        <h5 class="modal-title">
          {{ selectedPenalidad?.tipo === 'Monetaria' ? 'Registrar Pago' : 'Concluir Penalidad' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <p>¿Está seguro de que desea continuar?</p>
        
        <div class="card bg-light border-0 p-3 mb-3">
          <div class="row">
            <div class="col-12 mb-2">
              <strong>Cliente:</strong> {{ selectedPenalidad?.cliente?.nombres }} {{ selectedPenalidad?.cliente?.apellidoPaterno }}
            </div>
            <div class="col-12 mb-2">
              <strong>Motivo:</strong> {{ selectedPenalidad?.motivo }}
            </div>
            
            <div class="col-12" *ngIf="selectedPenalidad?.tipo === 'Monetaria'">
              <strong>Monto a Pagar:</strong> <span class="fs-5 text-success fw-bold ms-2">S/. {{ selectedPenalidad?.monto | number:'1.2-2' }}</span>
            </div>
            
            <div class="col-12" *ngIf="selectedPenalidad?.tipo !== 'Monetaria'">
              <span class="text-primary"><i class="bi bi-info-circle me-1"></i> Se levantará la suspensión/sanción asociada.</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" 
                class="btn text-white"
                [ngClass]="selectedPenalidad?.tipo === 'Monetaria' ? 'btn-success' : 'btn-primary'"
                (click)="confirmarResolucion()">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="confirmationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">¡Éxito!</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">
      {{ toastMessage }}
    </div>
  </div>
</div>