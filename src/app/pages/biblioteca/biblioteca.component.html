<app-navbar 
  (onCargarHistorial)="cargarHistorialUsuario()">
</app-navbar>

<div class="container my-5" *ngIf="isLoggedIn">
  <div class="row">

    <div class="col-lg-3 mb-4">
      <app-filtros (onSearch)="cargarLibros($event)"></app-filtros>
    </div>

    <div class="col-lg-9">
      
      <div class="row g-4">
        <div class="col-12 col-sm-6 col-md-6 col-lg-4" *ngFor="let libro of librosPaginados">
          
          <div class="card text-center shadow-sm h-100" style="border:2px solid #2B4D92; position: relative;">
            
            <span *ngIf="!isAdmin"
                  [ngClass]="getDisponibilidadClass(libro)"
                  style="position: absolute; top: 10px; right: 10px; font-size: 0.8rem; z-index: 2;">
              {{ getDisponibilidadLibro(libro) }}
            </span>

            <div class="card-body d-flex flex-column" style="padding-top: 2.5rem;">
              <i class="bi bi-book" style="font-size: 3rem;"></i>
              
              <h6 class="mt-3 fw-bold">{{ libro.titulo }}</h6>
              <p class="text-muted">{{ getAutor(libro) }}</p>
              <p class="text-muted small">Categoria: {{ libro.dewey?.categoria || 'N/A' }}</p> 

              <div class="d-flex justify-content-center gap-3 mt-auto" *ngIf="!isAdmin">
                <button class="btn btn-outline-warning" (click)="verificarDisponibilidad(libro, 'reserva')">Reservar</button>
                <button class="btn btn-outline-primary" (click)="verificarDisponibilidad(libro, 'prestamo')">Prestar</button>
              </div>
              
              <div class="mt-auto" *ngIf="isAdmin">
              </div>

            </div>
          </div>
        </div>

        <div *ngIf="libros.length === 0" class="col-12 text-center py-5">
          <h5>No se encontraron libros.</h5>
        </div>
      </div>
      
      <nav class="mt-4" *ngIf="libros.length > pageSize">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="page === 1">
            <a class="page-link" style="cursor: pointer;" (click)="cambiarPagina(page - 1)">«</a>
          </li>
          <li class="page-item"
              *ngFor="let p of paginas"
              [class.active]="page === p">
            <a class="page-link" style="cursor: pointer;" (click)="cambiarPagina(p)">{{ p }}</a>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages()">
            <a class="page-link" style="cursor: pointer;" (click)="cambiarPagina(page + 1)">»</a>
          </li>
        </ul>
      </nav>

    </div> 
  </div> 
</div> 


<app-footer></app-footer>

<div class="modal fade" id="seleccionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title">Ejemplares: {{ libroSeleccionado?.titulo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">Seleccione un ejemplar disponible para continuar:</p>
        
        <div class="list-group">
          <button *ngFor="let ej of ejemplaresDelLibro" 
                  type="button" 
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  [disabled]="ej.estado !== 'Disponible'" 
                  (click)="seleccionarEjemplar(ej)">
            
            <div class="d-flex align-items-center">
              <i class="bi bi-upc-scan me-2"></i> 
              <span [class.text-decoration-line-through]="ej.estado !== 'Disponible'">
                Código: <strong>{{ ej.codigoInterno }}</strong>
              </span>
            </div>

            <span [ngClass]="getBadgeClassForModal(ej.estado)">
              {{ ej.estado }}
            </span>

          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reservaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form [formGroup]="reservaForm" (ngSubmit)="onReservarSubmit()">
        <div class="modal-header" style="background-color: #2B4D92; color: white;">
          <h5 class="modal-title">Detalles de Reserva</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-4">
            <div class="col-md-5">
              <label class="form-label fw-bold">Libro:</label>
              <div class="card h-100 text-center">
                <div class="card-body d-flex flex-column justify-content-center align-items-center p-4">
                  <i class="bi bi-book" style="font-size: 4rem; color: #6c757d;"></i>
                  <h5 class="mt-3 mb-1">{{ libroSeleccionado?.titulo }}</h5>
                  <p class="text-muted mb-2">{{ getAutor(libroSeleccionado) }}</p>
                  <span class="badge bg-secondary">Ejemplar: {{ ejemplarSeleccionado?.codigoInterno }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-7">
               <div class="mb-3">
                <label for="fechaInicioReserva" class="form-label fw-bold">Fecha de Inicio:</label>
                <input type="date" id="fechaInicioReserva" class="form-control" formControlName="fechaReserva">
              </div>

              <div class="mb-3">
                <label for="fechaReserva" class="form-label fw-bold">Fecha de Expiración:</label>
                <input type="date" id="fechaReserva" class="form-control" formControlName="fechaExpiracion">
                <div class="form-text">MM/DD/YYYY</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="reservaForm.invalid">Confirmar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="prestamoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form [formGroup]="prestamoForm" (ngSubmit)="onPrestamoSubmit()">
        <div class="modal-header" style="background-color: #2B4D92; color: white;">
          <h5 class="modal-title">Detalles de Préstamo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-4">
            <div class="col-md-5">
              <label class="form-label fw-bold">Libro:</label>
              <div class="card h-100 text-center">
                <div class="card-body d-flex flex-column justify-content-center align-items-center p-4">
                  <i class="bi bi-book" style="font-size: 4rem; color: #6c757d;"></i>
                  <h5 class="mt-3 mb-1">{{ libroSeleccionado?.titulo }}</h5>
                  <p class="text-muted mb-2">{{ getAutor(libroSeleccionado) }}</p>
                   <span class="badge bg-secondary">Ejemplar: {{ ejemplarSeleccionado?.codigoInterno }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-7">
              <div class="mb-3">
                <label for="fechaPrestamo" class="form-label fw-bold">Seleccione la fecha de préstamo:</label>
                <input type="date" id="fechaPrestamo" class="form-control" formControlName="fechaPrestamo">
                <div class="form-text">MM/DD/YYYY</div>
              </div>
              <div class="mb-3">
                <label for="fechaDevolucion" class="form-label fw-bold">Seleccione la fecha de entrega:</label>
                <input type="date" id="fechaDevolucion" class="form-control" formControlName="fechaDevolucion">
                <div class="form-text">MM/DD/YYYY</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="prestamoForm.invalid">Confirmar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="confirmationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">¡Éxito!</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">
      {{ toastMessage }}
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="historialOffcanvas">
  
  <div class="offcanvas-header custom-offcanvas-header">
    <h5 class="offcanvas-title fw-bold">
      <i class="bi bi-book-fill me-2"></i>Mis Acciones
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    
    <div *ngIf="isLoadingHistorial" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2 text-muted small">Consultando biblioteca...</p>
    </div>

    <div *ngIf="!isLoadingHistorial">
      
      <h6 class="section-title">
        <i class="bi bi-journal-arrow-up me-2"></i> Préstamos Activos
      </h6>
      
      <div *ngIf="misPrestamos.length > 0; else noPrestamos">
        <div class="list-group list-group-flush">
          <div *ngFor="let prestamo of misPrestamos" class="list-group-item action-card prestamo-card">
            <span class="book-title">{{ prestamo.ejemplar.libro.titulo }}</span>
            <small class="date-info">
              <i class="bi bi-calendar-event me-2"></i> Devolución: 
              <span class="ms-1 fw-bold text-danger">{{ prestamo.fechaDevolucion | date: 'dd/MM/yyyy' }}</span>
            </small>
          </div>
        </div>
      </div>
      
      <ng-template #noPrestamos>
        <div class="empty-state mb-4">
          <i class="bi bi-journal-x fs-4 d-block mb-2"></i>
          No tienes préstamos activos actualmente.
        </div>
      </ng-template>


      <h6 class="section-title mt-4">
        <i class="bi bi-bookmark-star-fill me-2"></i> Reservas Activas
      </h6>
      
      <div *ngIf="misReservas.length > 0; else noReservas">
        <div class="list-group list-group-flush">
          <div *ngFor="let reserva of misReservas" class="list-group-item action-card reserva-card">
            <span class="book-title">{{ reserva.ejemplar.libro.titulo }}</span>
            <small class="date-info">
              <i class="bi bi-hourglass-split me-2"></i> Expira: 
              <span class="ms-1 fw-bold text-dark">{{ reserva.fechaExpiracion | date: 'dd/MM/yyyy' }}</span>
            </small>
          </div>
        </div>
      </div>

      <ng-template #noReservas>
         <div class="empty-state">
           <i class="bi bi-bookmark-x fs-4 d-block mb-2"></i>
           No tienes reservas activas.
         </div>
      </ng-template>

    </div>
  </div>
</div>