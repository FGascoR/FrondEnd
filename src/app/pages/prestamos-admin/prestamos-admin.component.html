<div class="container mt-4">
  
  <div class="row g-3 mb-3" [formGroup]="filterForm">
    <div class="col-md-3">
      <label class="form-label">Cliente</label>
      <input type="text" class="form-control" formControlName="clienteNombre" placeholder="Nombre o Apellido...">
    </div>
    <div class="col-md-3">
      <label class="form-label">Ejemplar</label>
      <input type="text" class="form-control" formControlName="ejemplarInfo" placeholder="Título o Código...">
    </div>
    <div class="col-md-3">
      <label class="form-label">Fecha de Prestamo</label>
      <input type="date" class="form-control" formControlName="fechaPrestamo">
    </div>
    <div class="col-md-3">
      <label class="form-label">Fecha de Devolución</label>
      <input type="date" class="form-control" formControlName="fechaDevolucion">
    </div>
  </div>

  <table class="table table-striped table-hover mt-3">
    <thead class="table-secondary">
      <tr>
        <th>Fecha Préstamo</th>
        <th>Fecha Límite</th>
        <th>Cliente</th>
        <th>Ejemplar (Libro)</th>
        <th>Estado</th>
        <th>Acciones</th> </tr>
    </thead>
    <tbody>
      <tr *ngFor="let prestamo of prestamos">
        <td>{{ prestamo.fechaPrestamo | date: 'dd/MM/yyyy' }}</td>
        <td>{{ prestamo.fechaDevolucion | date: 'dd/MM/yyyy' }}</td>
        <td>{{ prestamo.cliente?.nombres }} {{ prestamo.cliente?.apellidoPaterno }}</td>
        <td>{{ prestamo.ejemplar?.libro?.titulo }} (Cód: {{ prestamo.ejemplar?.codigoInterno }})</td>
        <td>
          <span [ngClass]="getEstadoClass(prestamo)">
            {{ getEstadoPrestamo(prestamo) }}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-info text-white" (click)="openDevolucionModal(prestamo)">
            <i class="bi bi-box-arrow-in-down-left me-1"></i> Devolver
          </button>
        </td>
      </tr>
      
      <tr *ngIf="isLoading">
        <td colspan="6" class="text-center">Cargando préstamos activos...</td>
      </tr>
      <tr *ngIf="!isLoading && prestamos.length === 0">
        <td colspan="6" class="text-center">No hay préstamos activos para mostrar.</td>
      </tr>
    </tbody>
  </table>
</div>


<div class="modal fade" id="devolucionModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg"> <div class="modal-content">
      <form [formGroup]="devolucionForm" (ngSubmit)="onDevolucionSubmit()">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Registrar Devolución</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          <div class="alert alert-light border mb-3">
            <div class="row">
              <div class="col-md-6">
                <strong>Cliente:</strong> {{ selectedPrestamo?.cliente?.nombres }} {{ selectedPrestamo?.cliente?.apellidoPaterno }}
              </div>
              <div class="col-md-6">
                <strong>Libro:</strong> {{ selectedPrestamo?.ejemplar?.libro?.titulo }}
              </div>
              <div class="col-md-6">
                <strong>Ejemplar:</strong> {{ selectedPrestamo?.ejemplar?.codigoInterno }}
              </div>
              <div class="col-md-6">
                <strong>Fecha Límite:</strong> {{ selectedPrestamo?.fechaDevolucion | date: 'dd/MM/yyyy' }}
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <h6 class="fw-bold">Detalles de la Devolución</h6>
              
              <div class="mb-3">
                <label class="form-label">Estado del ejemplar devuelto:</label>
                <select class="form-select" formControlName="estadoEjemplar">
                  <option value="Bueno">Bueno</option>
                  <option value="Regular">Regular</option>
                  <option value="Malo">Malo</option>
                </select>
                <div class="form-text">El ejemplar volverá al estado "Disponible".</div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Observaciones (opcional):</label>
                <textarea class="form-control" rows="2" formControlName="observaciones"></textarea>
              </div>

              <hr class="my-4">

              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold m-0">Penalidad (Opcional)</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="addPenalidadCheck" formControlName="addPenalidad">
                  <label class="form-check-label" for="addPenalidadCheck">Aplicar</label>
                </div>
              </div>

              <div *ngIf="devolucionForm.get('addPenalidad')?.value" class="card bg-light border-0 p-3">
                
                <div class="mb-3">
                  <label class="form-label small fw-bold">Tipo de Penalidad:</label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" formControlName="tipoPenalidad" id="tipoMonetaria" value="Monetaria">
                    <label class="btn btn-outline-danger" for="tipoMonetaria">
                      <i class="bi bi-cash-coin me-2"></i> Monetaria
                    </label>
                  
                    <input type="radio" class="btn-check" formControlName="tipoPenalidad" id="tipoSuspension" value="Suspension">
                    <label class="btn btn-outline-warning" for="tipoSuspension">
                      <i class="bi bi-slash-circle me-2"></i> Suspensión / Otro
                    </label>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4" *ngIf="devolucionForm.get('tipoPenalidad')?.value === 'Monetaria'">
                    <label class="form-label">Monto (S/.)</label>
                    <div class="input-group">
                      <span class="input-group-text">S/.</span>
                      <input type="number" class="form-control" formControlName="montoPenalidad" placeholder="0.00">
                    </div>
                    <div *ngIf="devolucionForm.get('montoPenalidad')?.invalid && devolucionForm.get('montoPenalidad')?.touched" class="text-danger small">
                      Requerido.
                    </div>
                  </div>

                  <div [ngClass]="devolucionForm.get('tipoPenalidad')?.value === 'Monetaria' ? 'col-md-8' : 'col-md-12'">
                    <label class="form-label">Motivo / Detalle</label>
                    <input type="text" class="form-control" formControlName="motivo" 
                           placeholder="{{ devolucionForm.get('tipoPenalidad')?.value === 'Monetaria' ? '' : '' }}">
                    <div *ngIf="devolucionForm.get('motivo')?.invalid && devolucionForm.get('motivo')?.touched" class="text-danger small">
                      El motivo es obligatorio.
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-info text-white" [disabled]="devolucionForm.invalid">
            Confirmar Devolución
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="confirmationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">¡Éxito!</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">
      {{ toastMessage }}
    </div>
  </div>
</div>