<div class="container mt-4">
  
  <div class="d-flex justify-content-end mb-3">
    <div>
      <button class="btn btn-success" (click)="openDevolucionModal()">
        <i class="bi bi-journal-check me-1"></i> Registrar Devolución
      </button>
    </div>
  </div>

  <div class="row g-3 mb-3" [formGroup]="filterForm">
    <div class="col-md-3">
      <label class="form-label">Cliente</label>
      <input type="text" class="form-control" formControlName="clienteNombre" placeholder="Nombre o Apellido...">
    </div>
    <div class="col-md-3">
      <label class="form-label">Ejemplar</label>
      <input type="text" class="form-control" formControlName="ejemplarInfo" placeholder="Título o Código...">
    </div>
    <div class="col-md-3">
      <label class="form-label">Fecha de Prestamo</label>
      <input type="date" class="form-control" formControlName="fechaPrestamo">
    </div>
    <div class="col-md-3">
      <label class="form-label">Fecha de Devolución</label>
      <input type="date" class="form-control" formControlName="fechaDevolucion">
    </div>
  </div>

  <table class="table table-striped table-hover mt-3">
    <thead class="table-secondary">
      <tr>
        <th>Fecha Préstamo</th>
        <th>Fecha Devolución (Límite)</th>
        <th>Cliente</th>
        <th>Ejemplar (Libro)</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let prestamo of prestamos">
        <td>{{ prestamo.fechaPrestamo | date: 'dd/MM/yyyy' }}</td>
        <td>{{ prestamo.fechaDevolucion | date: 'dd/MM/yyyy' }}</td>
        <td>{{ prestamo.cliente?.nombres }} {{ prestamo.cliente?.apellidoPaterno }}</td>
        <td>{{ prestamo.ejemplar?.libro?.titulo }} (Cód: {{ prestamo.ejemplar?.codigoInterno }})</td>
        <td>
          <span [ngClass]="getEstadoClass(prestamo)">
            {{ getEstadoPrestamo(prestamo) }}
          </span>
        </td>
      </tr>
      
      <tr *ngIf="isLoading">
        <td colspan="5" class="text-center">Cargando préstamos activos...</td>
      </tr>
      <tr *ngIf="!isLoading && prestamos.length === 0">
        <td colspan="5" class="text-center">No hay préstamos activos para mostrar.</td>
      </tr>
    </tbody>
  </table>
</div>


<div class="modal fade" id="devolucionModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form [formGroup]="devolucionForm" (ngSubmit)="onDevolucionSubmit()">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Registrar Devolución</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          <div class="row g-4">
            
            <div class="col-md-5">
              <h6 class="fw-bold">Paso 1: Buscar Cliente</h6>
              <div class="mb-3">
                <label class="form-label">Filtrar Cliente:</label>
                <input type="text" class="form-control" formControlName="clienteFilter" placeholder="Buscar por nombre o apellido...">
              </div>
              <div class="mb-3">
                <label for="clienteSelect" class="form-label">Seleccionar Cliente:</label>
                <select id="clienteSelect" class="form-select" formControlName="clienteId">
                  <option [ngValue]="null" disabled>
                    {{ isLoadingClientes ? 'Cargando...' : 'Seleccione un cliente' }}
                  </option>
                  <option *ngFor="let cliente of filteredClientes" [ngValue]="cliente.idCliente">
                    {{ cliente.nombres }} {{ cliente.apellidoPaterno }}
                  </option>
                </select>
              </div>
              
              <hr class="my-4">

              <h6 class="fw-bold">Paso 2: Seleccionar Préstamo a Devolver</h6>
              <div *ngIf="isLoadingPrestamosCliente" class="text-center">
                <div class="spinner-border spinner-border-sm" role="status"></div>
              </div>
              <div *ngIf="!isLoadingPrestamosCliente && prestamosDelCliente.length > 0">
                <div class="list-group" style="max-height: 250px; overflow-y: auto;">
                  <label *ngFor="let p of prestamosDelCliente" class="list-group-item list-group-item-action">
                    <input class="form-check-input me-2" type="radio" [value]="p.idPrestamo" formControlName="prestamoId">
                    <strong>{{ p.ejemplar?.libro?.titulo }}</strong>
                    <small class="d-block text-muted">Devolución: {{ p.fechaDevolucion | date: 'dd/MM/yyyy' }}</small>
                  </label>
                </div>
              </div>
              <div *ngIf="!isLoadingPrestamosCliente && prestamosDelCliente.length === 0 && devolucionForm.get('clienteId')?.value" class="alert alert-warning small p-2">
                Este cliente no tiene préstamos activos.
              </div>
            </div>

            <div class="col-md-7 border-start">
              
              <h6 class="fw-bold">Paso 3: Detalles de la Devolución</h6>
              <div class="mb-3">
                <label class="form-label">Estado del ejemplar devuelto:</label>
                
                <select class="form-select" formControlName="estadoEjemplar">
                  <option value="Bueno">Bueno</option>
                  <option value="Regular">Regular</option>
                  <option value="Malo">Malo</option>
                </select>
                <div class="form-text"></div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Observaciones (opcional):</label>
                <textarea class="form-control" rows="2" formControlName="observaciones"></textarea>
              </div>

              <hr class="my-4">

              <h6 class="fw-bold">Paso 4: Penalidad (Opcional)</h6>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="addPenalidadCheck" formControlName="addPenalidad">
                <label class="form-check-label" for="addPenalidadCheck">Registrar Penalidad</label>
              </div>

              <div *ngIf="devolucionForm.get('addPenalidad')?.value">
                <div class="row">
                  <div class="col-md-4">
                    <label class="form-label">Monto (S/.)</label>
                    <input type="number" class="form-control" formControlName="montoPenalidad">
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Motivo de la Penalidad</label>
                    <input type="text" class="form-control" formControlName="motivo"> 
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success" [disabled]="devolucionForm.invalid">
            Confirmar Devolución
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="confirmationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">¡Éxito!</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">
      {{ toastMessage }}
    </div>
  </div>
</div>